<?php

use Slim\Http\Request;
use Slim\Http\Response;

// Routes

//TO DO:
//DESTROY ALL SQL INJECTIONS!!!

// get all todos
    $app->get('/todos', function ($request, $response, $args) {

	$query = $_GET["query"]; //Get query from parameter
	if(empty($query)){
		$query = "select * from ra;";
	}
        $sth = $this->db->prepare($query);
        $sth->execute();
	try
	{
       		$todos = $sth->fetchAll();
	}
	catch(PDOException $e)
	{
		$todos = 'Query Submitted';
	}
//$todos =0;
  return $this->response->withJson($todos);
    });

//Testing post requests
    $app->post('/postplz', function ($request, $response, $args) {
	$todos = 0;
	//$query = "insert into event (eventname, location, datetime, description, uid) values (%27testEvent%27, %27SMU%27, %271000-01-01 00:00:00%27, %27Test event%27, 12345678);";
	//$sth = $this->db->prepare($query);
	//$sth->execute();
	return $this->response->withJson($todos);
    });


    $app->get('/login', function ($request, $response, $args) {

        $id = $_GET["id"]; //Get query from parameter
	$pass = $_GET["pass"];
	$pass = hash('sha256', $pass); //Hash password with SHA256
	$query = "SELECT * FROM ra WHERE id=:id AND password=:pass";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":id" => $id, ":pass" => $pass));
        try
        {
                $todos = $sth->fetchAll();

		if(count($todos) > 0)
		{
			$todos = array(array(type => 'ra'));
		}
		else
		{
		       $query = "SELECT * FROM student WHERE id=:id AND password=:pass";
		       $sth = $this->db->prepare($query);
			$sth->execute(array(":id" => $id, ":pass" => $pass));
	        	try
        		{
                		$todos = $sth->fetchAll();

                		if(count($todos) > 0)
                		{
                        		$todos = array(array(type => 'student'));
                		}
				else
				{
					$todos = array(array(type => 'failure'));
				}
        		}
        		catch(PDOException $e)
        		{
				$todos = array(array(type => 'failure'));
			}
		}
        }
        catch(PDOException $e)
       {

        	$todos = array(array(type => 'failure'));
//$todos =0;
	}
  return $this->response->withJson($todos);
    });

/*
 $app->get('/studentLogin', function ($request, $response, $args) {

        $id = $_GET["id"]; //Get query from parameter
        $pass = $_GET["pass"];
        $query = "SELECT * FROM student WHERE id=:id AND password=:pass";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":id" => $id, ":pass" => $pass));
        try
        {
                $todos = $sth->fetchAll();

                if(count($todos) > 0)
                {
                        $todos = 'Login Success';
                }
        }
        catch(PDOException $e)
        {
               $todos = 'Login Failed';
        }
//$todos =0;
  return $this->response->withJson($todos);
    });

*/
 $app->post('/signup', function ($request, $response, $args) {

	if($_REQUEST["isra"])
	{
		$table = ra;
	}
	else			//RA or student table
	{
		$table = student;
	}


	//Check to see if account exists

        $id = $_REQUEST["id"]; //Get query from parameter
	$query = "SELECT * FROM $table WHERE id=:id";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":id" => $id));
        try
        {
        	$todos = $sth->fetchAll();

        	if(count($todos) > 0)
                {
			$success = False;
                	$todos = array(array(success => False));
                }
                else
                {
			$success = True;
                	$todos = array(array(success => True));
                }
        }
        catch(PDOException $e)
        {
		$success = False;
        	$todos = array(array(success => False));
        }


	if($success)	//Only do if account is new
{
	$firstname = $_REQUEST["firstname"];
	$lastname = $_REQUEST["lastname"];
	$email = $_REQUEST["email"];
	$pass = $_REQUEST["pass"];
	$pass = hash('sha256', $pass);
	$phone = $_REQUEST["phone"];//Get query from parameter
	$dorm = $_REQUEST["dorm"];
	$room = $_REQUEST["room"];
	$ename = $_REQUEST["ename"];
	$erelation = $_REQUEST["erelation"];
        $ephone = $_REQUEST["ephone"];
	$query = "insert into $table (firstname, lastname, email, password, phone, id, dorm, room, ename, erelation, ephone) values (:firstname, :lastname, :email, :pass, :phone, :id, :dorm, :room, :ename, :erelation, :ephone);";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":firstname" => $firstname, ":lastname" => $lastname, ":email" => $email, ":pass" => $pass, ":phone" => $phone, ":id" => $id, ":dorm" => $dorm, ":room" => $room, ":ename" => $ename, ":erelation" => $erelation, ":ephone" => $ephone));
}

        return $this->response->withJson($todos);
    });


    $app->get('/residentInfo', function ($request, $response, $args) {

        $id = $_GET["id"]; //Get query from parameter
        $query = "SELECT email, phone, emergency FROM student WHERE id='$id';";
        $sth = $this->db->prepare($query);
        $sth->execute();
        try
        {
                $todos = $sth->fetchAll();
        }
        catch(PDOException $e)
        {
                $todos = 'Query Submitted';
        }

  return $this->response->withJson($todos);
    });


    $app->post('/feedback', function ($request, $response, $args) {

        $ra_id = $_REQUEST["id"];
	$feedback = $_REQUEST["feedback"];
        $query = "insert into feedback (ra_id, feedback) values ('$ra_id', '$feedback');";
        $sth = $this->db->prepare($query);
        $sth->execute();
        $todos = array(array(success => True));

  return $this->response->withJson($todos);
    });

   $app->get('/{ra_id}/feedback', function ($request, $response, $args) {

	  $ra_id=$args['ra_id'];
//          $ra_id = $_GET["ra_id"]; //Get query from parameter
          $query = "SELECT feedback FROM feedback WHERE ra_id=:ra_id;";
          $sth = $this->db->prepare($query);
          $sth->execute(array(":ra_id" => $ra_id));
	//echo var_dump($sth);
          try
	{
                  $todos = $sth->fetchAll();
		 //echo var_dump($todos);
		//$todos = 'log succesful';
                  if(count($todos) > 0)
                  {
                       	 // $todos =  "Request Successful";
			  //while ($row = $sth->fetchArray()) {
                          // echo "Feedback: " . $row["feedback"] . "<br>";
                         //}
			//echo $todos;
                  } 
          }
          catch(PDOException $e)
          {
                 $todos = 'Request Failed';
          }
    return $this->response->withJson($todos);
      });


    /*
    $app->get('/getplz/{name}', function ($request, $response, $args) {
        $todos = 0;
         $name = $req->getAttribute('name', '== not set ==');
        echo $name;
        return $this->response->withJson($todos);
    });*/

      $app->get('/{current_id}/current_ra', function ($request, $response, $args) {

              // $current_id = $_GET["resident_id"]; //Get query from parameter
              $current_id=$args['current_id'];
	      $query = "SELECT ra.firstname, ra.lastname FROM ra JOIN student ON substr(ra.room, 1, 1)=substr(student.room, 1, 1) AND ra.dorm=student.dorm WHERE student.id=:current_id;";
              $sth = $this->db->prepare($query);
              $sth->execute(array(':current_id' => $current_id));
              try
              {
                      $todos = $sth->fetchAll();
              }
              catch(PDOException $e)
              {
                      $todos = 'Query Failed';
              }

        return $this->response->withJson($todos);
          });

  $app->get('/{ra_id}/get_residents', function ($request, $response, $args) {

              // $current_id = $_GET["resident_id"]; //Get query from parameter
              $ra_id=$args['ra_id'];
              $query = "SELECT student.lastname FROM ra JOIN student ON ra.id=student.ra_id WHERE ra.id='$ra_id';";
              $sth = $this->db->prepare($query);
              $sth->execute();
              try
              {
                      $todos = $sth->fetchAll();
              }
              catch(PDOException $e)
              {
                      $todos = 'Query Failed';
              }

        return $this->response->withJson($todos);
          });

	 $app->get('/{event_id}/get_event', function ($request, $response, $args) {

                        $event_id=$args['event_id'];
               	        $query = "SELECT * FROM event WHERE event.event_id='$event_id';";
                        $sth = $this->db->prepare($query);
                        $sth->execute();
                        try
                        {
                                $todos = $sth->fetchAll();
                        }
                        catch(PDOException $e)
                        {
                                $todos = 'Query Failed';
                        }

                  return $this->response->withJson($todos);
                    });

    $app->get('/get_calendar', function ($request, $response, $args) {
                    $query = "SELECT eventname,location,datetime,description,uid,picurl FROM event;";
                          $sth = $this->db->prepare($query);
                          $sth->execute();
                          try
                          {
                                  $todos = $sth->fetchAll();
                          }
                          catch(PDOException $e)
                          {
                                  $todos = 'Query Failed';
                          }

                    return $this->response->withJson($todos);
                      });


    $app->get('/[{name}]', function (Request $request, Response $response, array $args) {
        // Sample log message
        $this->logger->info("Slim-Skeleton '/' route");

        // Render index view
        return $this->renderer->render($response, 'index.phtml', $args);
    });
//This is an event post request
$app->post('/createEvent', function ($request, $response, $args){
        $event_id = $_REQUEST["event_id"];
        $eventname = $_REQUEST["eventname"];
        $location = $_REQUEST["location"];
        $datetime = $_REQUEST["datetime"];
        $description = $_REQUEST["description"];
        $uid = $_REQUEST["uid"];
        $picurl = $_REQUEST["picurl"];
        $query="insert into event (event_id, eventname, location, datetime, description, uid, picurl) values (:event_id, :eventname, :location, :datetime, :description, :uid, :picurl);";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":event_id" => $event_id, ":eventname" => $eventname, ":location" => $location, ":datetime" => $datetime, ":description" => $description, ":uid" => $uid, ":picurl" => $picurl));
        $todos = 'Query Submitted';

        return $this->response->withJson($todos);
    });


$app->post('/createWorkOrder', function ($request, $response, $args){
        $id = $_REQUEST["id"];
        $description = $_REQUEST["description"];
        $query="insert into worder (id, description) values (:id, :description);";
        $sth = $this->db->prepare($query);
        $sth->execute(array(":id" => $id, ":description" => $description));
        if(is_numeric($id)==true && $description!=null)
        {
		 $todos = 'Order Submitted';
        }
        else
        {
		$todos = 'Query Failed';
	
        return $this->response->withJson($todos);
          });
